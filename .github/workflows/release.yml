name: Build and Release

on:
  push:
    tags:
      - "v*" # íƒœê·¸ê°€ vë¡œ ì‹œì‘í•  ë•Œ íŠ¸ë¦¬ê±° (ì˜ˆ: v1.0.0)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: macOS-arm64
            arch: arm64
            python-version: "3.11"
            executable-name: "FM-Radio-Enhanced-macOS-arm64"
            file-extension: ""
          - os: windows-latest
            platform: Windows-x64
            arch: x64
            python-version: "3.11"
            executable-name: "FM-Radio-Enhanced-Windows-x64"
            file-extension: ".exe"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.arch }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache PyInstaller
        uses: actions/cache@v3
        with:
          path: |
            build/
            __pycache__/
          key: ${{ runner.os }}-pyinstaller-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-pyinstaller-

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # libusb ì„¤ì¹˜ (USB í†µì‹ ì„ ìœ„í•´ í•„ìš”)
          brew install libusb
          # ë¹Œë“œ íˆ´ ì„¤ì¹˜
          brew install create-dmg || true

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          # Windowsìš© libusb ì„¤ì¹˜ (vcpkg ì‚¬ìš©)
          # choco install libusb ëŒ€ì‹  pipìœ¼ë¡œ ì„¤ì¹˜
          echo "libusb will be handled by Python packages"

      - name: Install Python dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip setuptools wheel
          echo "Installing requirements from requirements.txt..."
          pip install -r requirements.txt
          echo "Installing PyInstaller..."
          pip install pyinstaller
          echo "Cleaning up unnecessary packages to save memory..."
          pip uninstall -y matplotlib numpy scipy pandas || echo "Some packages were not installed, skipping..."
          echo "âœ… Dependencies installed successfully!"
          echo "Installed packages:"
          pip list

      - name: Build executable with PyInstaller (macOS)
        if: runner.os == 'macOS'
        timeout-minutes: 45
        run: |
          echo "ğŸ”§ Building macOS executable..."
          echo "Python version: $(python --version)"
          echo "PyInstaller version: $(pyinstaller --version)"
          echo "Working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la

          # ë©”ëª¨ë¦¬ ì •ë³´ í™•ì¸
          echo "Memory info:"
          vm_stat | head -5

          # spec íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ
          echo "ğŸš€ Starting PyInstaller build..."
          pyinstaller build.spec --clean --noconfirm --log-level INFO

          echo "âœ… Build completed. Checking output..."
          # ì‹¤í–‰ íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          ls -la dist/

          # macOSì—ì„œ app ë²ˆë“¤ í™•ì¸
          if [ -d "dist/FM-Radio-Enhanced-macOS-arm64.app" ]; then
            echo "ğŸ“± Found app bundle!"
            ls -la "dist/FM-Radio-Enhanced-macOS-arm64.app"
          else
            echo "âš ï¸ App bundle not found, checking for executable..."
            ls -la dist/
          fi

          echo "ğŸ¯ macOS build finished!"

      - name: Build executable with PyInstaller (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 45
        run: |
          Write-Host "ğŸ”§ Building Windows executable..." -ForegroundColor Green
          Write-Host "Python version: $(python --version)" -ForegroundColor Cyan
          Write-Host "PyInstaller version: $(pyinstaller --version)" -ForegroundColor Cyan
          Write-Host "Working directory: $(Get-Location)" -ForegroundColor Cyan
          Write-Host "Files in current directory:" -ForegroundColor Cyan
          Get-ChildItem

          # ë©”ëª¨ë¦¬ ì •ë³´ í™•ì¸
          Write-Host "Memory info:" -ForegroundColor Cyan
          Get-WmiObject -Class Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory

          # spec íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ
          Write-Host "ğŸš€ Starting PyInstaller build..." -ForegroundColor Green
          pyinstaller build.spec --clean --noconfirm --log-level INFO

          Write-Host "âœ… Build completed. Checking output..." -ForegroundColor Green
          # ì‹¤í–‰ íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          Get-ChildItem dist/

          Write-Host "ğŸ¯ Windows build finished!" -ForegroundColor Green

      - name: Create distribution directory
        run: |
          mkdir -p dist-final

      - name: Prepare distribution files (macOS)
        if: runner.os == 'macOS'
        run: |
          # .app ë²ˆë“¤ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì „ì²´ ì•±ì„ íŒ¨í‚¤ì§•
          if [ -d "dist/FM-Radio-Enhanced-macOS-arm64.app" ]; then
            echo "ğŸ“± Packaging .app bundle..."
            # .app ë²ˆë“¤ ì „ì²´ë¥¼ dist-finalë¡œ ë³µì‚¬
            cp -r "dist/FM-Radio-Enhanced-macOS-arm64.app" "dist-final/"
            
            # READMEì™€ ë¼ì´ì„ ìŠ¤ íŒŒì¼ ì¶”ê°€
            cp README.md dist-final/ || echo "README.md not found, skipping"
            cp LICENSE dist-final/ || echo "LICENSE not found, skipping"
            
            # .app ë²ˆë“¤ì„ í¬í•¨í•œ ì••ì¶• íŒŒì¼ ìƒì„±
            cd dist-final
            tar -czf "../${{ matrix.executable-name }}.tar.gz" *
            cd ..
            
            echo "âœ… Created .app bundle package: ${{ matrix.executable-name }}.tar.gz"
          else
            echo "âš ï¸ .app bundle not found, packaging executable..."
            # ì‹¤í–‰ íŒŒì¼ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ íŒ¨í‚¤ì§•
            if [ -f "dist/${{ matrix.executable-name }}" ]; then
              cp "dist/${{ matrix.executable-name }}" "dist-final/"
              chmod +x "dist-final/${{ matrix.executable-name }}"
            fi
            
            # READMEì™€ ë¼ì´ì„ ìŠ¤ íŒŒì¼ ì¶”ê°€
            cp README.md dist-final/ || echo "README.md not found, skipping"
            cp LICENSE dist-final/ || echo "LICENSE not found, skipping"
            
            # ì••ì¶• íŒŒì¼ ìƒì„±
            cd dist-final
            tar -czf "../${{ matrix.executable-name }}.tar.gz" *
            cd ..
          fi

      - name: Prepare distribution files (Windows)
        if: runner.os == 'Windows'
        run: |
          # ì‹¤í–‰ íŒŒì¼ì„ dist-finalë¡œ ë³µì‚¬
          Copy-Item "dist\${{ matrix.executable-name }}${{ matrix.file-extension }}" "dist-final\"

          # READMEì™€ ë¼ì´ì„ ìŠ¤ íŒŒì¼ ì¶”ê°€
          if (Test-Path "README.md") { Copy-Item "README.md" "dist-final\" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "dist-final\" }

          # ZIP íŒŒì¼ ìƒì„±
          Compress-Archive -Path "dist-final\*" -DestinationPath "${{ matrix.executable-name }}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.executable-name }}
          path: |
            ${{ matrix.executable-name }}.tar.gz
            ${{ matrix.executable-name }}.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          name: FM Radio Enhanced ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## ğŸ“» FM Radio Enhanced ${{ github.ref_name }}

            ### ğŸ“¥ Download
            - **ğŸ macOS (ARM64)**: Download `FM-Radio-Enhanced-macOS-arm64.tar.gz`
            - **ğŸªŸ Windows (x64)**: Download `FM-Radio-Enhanced-Windows-x64.zip`

            ### ğŸš€ Installation

            #### macOS
            1. Download the `.tar.gz` file
            2. Extract: `tar -xzf FM-Radio-Enhanced-macOS-arm64.tar.gz`
            3. Run: `./FM-Radio-Enhanced-macOS-arm64`

            #### Windows
            1. Download the `.zip` file
            2. Extract the ZIP file
            3. Run: `FM-Radio-Enhanced-Windows-x64.exe`

            ### ğŸ’» System Requirements
            - **macOS**: macOS 11.0+ (Big Sur) with Apple Silicon (M1/M2)
            - **Windows**: Windows 10/11 (64-bit)
            - Compatible Samsung Galaxy device with FM radio capability
            - USB connection

            ### ğŸ“± Supported Devices
            - Samsung Galaxy devices with Product IDs: 0xa054, 0xa059, 0xa05b

            ### âœ¨ Features
            - FM Radio control and tuning
            - RDS (Radio Data System) support
            - Station presets and scanning
            - Signal strength monitoring
            - Volume and mute controls
            - Recording functionality
            - Modern, intuitive GUI

            ---
            **âš ï¸ Note**: This application requires a compatible Samsung Galaxy device connected via USB.

            ## ğŸ“ Changelog
          files: |
            artifacts/FM-Radio-Enhanced-macOS-arm64/FM-Radio-Enhanced-macOS-arm64.tar.gz
            artifacts/FM-Radio-Enhanced-Windows-x64/FM-Radio-Enhanced-Windows-x64.zip
          draft: false
          prerelease: false
